<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>File API</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<style>
		</style>
	</head>
	<body>
		<header role="banner">
			<h1>File API</h1>
			<p>File APIの練習サイトです。</p>
		</header>

		<main>
			<section>
				<h2>ファイルのメタ情報を取得</h2>
				<div>
					<textarea id="FileMetaInfo" cols="55" rows="10" readonly="readonly">
					</textarea>
				</div>
				<p>メタ情報取得対象選択</p>
				<p><input id="FileMetaTarget" type="file" multiple="multiple" /></p>
			</section>
			<section>
				<h2>Blob URLを利用して画像ファイルを描画</h2>
				<p>描画対象画像選択</p>
				<label><input id="FileHalfCheck" type="checkbox" />画像を半分にスライス</label>
				<p><input id="FileBlobTarget" type="file" multiple="multiple" /></p>
				<div id="FileBlobContainer">
				</div>
			</section>
			<section>
				<h2>画像ファイルのData URLを表示</h2>
				<div>
					<textarea id="FileDataURL" cols="120" rows="10" readonly="readonly">
					</textarea>
				</div>
				<p>Data URL表示対象画像選択</p>
				<p><input id="FileDataURLTarget" type="file" multiple="multiple" /></p>
			</section>
		</main>

		<footer role="contentinfo">
			<small>Copyright &copy; 2014 moguonyanko All rights reserved.</small>
		</footer>

		<script>
			(function (win, doc) {

				function getFileMetaInfo(files, opt_separator) {
					var info = [],
						separator = opt_separator || "\n";

					if (files) {
						for (var i = 0; i < files.length; i++) {
							var file = files.item(i);
							info.push("ファイル名：" + file.name);
							info.push("ファイルサイズ：" + file.size);
							info.push("ファイルMIMEタイプ：" + file.type);
							info.push("最終更新日時：" + file.lastModifiedDate);
							info.push(separator);
						}
					}

					return info.join(separator);
				}

				function getBlobImage(blob, opt) {
					if (opt && opt.half) {
						blob = blob.slice(0, blob.size / 2, blob.type);
					}

					var img = new Image(),
						url = win.URL.createObjectURL(blob);

					img.onload = function () {
						win.URL.revokeObjectURL(url);
					};
					img.src = url;

					return img;
				}

				function isImage(file) {
					return /^image\//.test(file.type);
				}

				/**
				 * イベントハンドラの引数からFileListオブジェクトは得られない。 
				 */

				function handleFileMetaInfo(evt) {
					var selectedFiles = this.files;
					var infoArea = doc.getElementById("FileMetaInfo");
					infoArea.value = "";
					var info = getFileMetaInfo(selectedFiles);
					infoArea.value += info;
				}

				function handleImageFile(evt) {
					var selectedFiles = this.files;

					var imgContainer = doc.getElementById("FileBlobContainer"),
						imgKeyword = "FileImage",
						imgClassName = imgKeyword;

					var oldImgs = doc.querySelectorAll("." + imgClassName);

					Array.prototype.forEach.call(oldImgs, function (img, idx, imgs) {
						imgContainer.removeChild(img);
					});

					var half = doc.getElementById("FileHalfCheck").checked;

					for (var i = 0, max = selectedFiles.length; i < max; i++) {
						var file = selectedFiles.item(i);

						if (isImage(file)) {
							var img = getBlobImage(file, {
								half: half
							});
							img.setAttribute("class", imgClassName);
							imgContainer.appendChild(img);
						} else {
							console.log("画像ファイルではありません。 ... " + file.name);
						}
					}
				}

				function getDataURL(files, callback) {
					for (var i = 0, max = files.length; i < max; i++) {
						var file = files.item(i);

						if (isImage(file)) {
							/**
							 * 1つのファイル読み込み毎にFileReaderオブジェクトを
							 * 生成する必要がある。
							 */
							var reader = new FileReader();
							reader.onload = callback;
							reader.readAsDataURL(file);
						}
					}
				}

				function handleDataURL() {
					var resultArea = doc.getElementById("FileDataURL");
					resultArea.value = "";

					var dispDataURL = function (evt) {
						var result = evt.target.result;
						resultArea.value += result + "\n<END>\n";
					};

					getDataURL(this.files, dispDataURL);
				}

				function addEventListener() {
					var fileInput = doc.getElementById("FileMetaTarget");
					fileInput.addEventListener("change", handleFileMetaInfo, false);

					var blobInput = doc.getElementById("FileBlobTarget");
					blobInput.addEventListener("change", handleImageFile, false);

					var dataURLInput = doc.getElementById("FileDataURLTarget");
					dataURLInput.addEventListener("change", handleDataURL, false);
				}

				function init() {
					addEventListener();
				}

				init();

			}(window, document));
		</script>
	</body>
</html>
